<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾äººæµèª¿åº¦æ™‚ç©ºåœ–ï¼ˆå«åœ°åœ–èˆ‡GPXè§£æï¼‰</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Leaflet åœ°åœ– CSS å’Œ JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <!-- è¨­å®š Tailwind é…ç½®å’Œ Inter å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        #chart-container {
            width: 100%;
            overflow-x: auto;
        }
        canvas {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #map {
            height: 350px; /* åœ°åœ–é«˜åº¦ */
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            z-index: 1; /* ç¢ºä¿åœ°åœ–åœ–å±¤æ­£ç¢º */
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        /* éš±è— number input çš„ä¸Šä¸‹ç®­é ­ (Chrome, Safari, Edge, Opera) */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">ğŸƒâ€â™‚ï¸ é¦¬æ‹‰æ¾äººæµèª¿åº¦æ¨¡æ“¬ï¼šæ™‚ç©ºåœ–</h1>
    <p class="text-gray-600 mb-6">è«‹ä¸Šå‚³ GPX æª”æ¡ˆä¸¦èª¿æ•´åƒæ•¸ï¼Œåˆ†æè³½é“é‡ç–Šèˆ‡ç“¶é ¸è¡çªã€‚</p>

    <div class="flex flex-col lg:flex-row gap-6">

        <!-- å·¦å´ï¼šåƒæ•¸è¨­å®šå€ -->
        <div class="lg:w-1/3 bg-white p-6 rounded-xl shadow-lg h-full">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">åƒæ•¸è¨­å®šèˆ‡ GPX åŒ¯å…¥</h2>
            <div id="controls" class="space-y-6">
                
                <!-- 21K åŠé¦¬çµ„ -->
                <div id="group-21k" class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-blue-800 mb-2">åŠé¦¬çµ„ (21K)</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="21k-file" class="block text-sm font-medium text-gray-700">GPX æª”æ¡ˆä¸Šå‚³ (.gpx)</label>
                            <input type="file" id="21k-file" accept=".gpx" class="w-full p-1 border border-blue-200 rounded-lg text-sm font-mono" onchange="handleFileUpload(event, '21k')">
                            <p id="21k-dist-display" class="text-xs text-blue-600 mt-1 font-semibold">ç¸½è·é›¢: -- km</p>
                        </div>
                        
                        <!-- å‡ºç™¼æ™‚é–“æ”¹ç‚º HH:MM è¼¸å…¥ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç™¼æ™‚é–“ (æ™‚:åˆ†)</label>
                            <div class="flex items-center space-x-2">
                                <div class="relative flex-1">
                                    <input type="number" id="21k-start-h" value="6" min="0" max="23" class="w-full p-2 text-center border border-blue-200 rounded-lg font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="æ™‚">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">æ™‚</span>
                                </div>
                                <span class="text-gray-400 font-bold">:</span>
                                <div class="relative flex-1">
                                    <input type="number" id="21k-start-m" value="00" min="0" max="59" class="w-full p-2 text-center border border-blue-200 rounded-lg font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="åˆ†">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">åˆ†</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="21k-pace-fast" class="block text-sm font-medium text-gray-700">æœ€å¿«é…é€Ÿ (min/km): <span id="val-21k-pace-fast" class="font-mono text-blue-600">4.5</span></label>
                                <input type="range" id="21k-pace-fast" value="4.5" min="3" max="8" step="0.5" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="21k-pace-slow" class="block text-sm font-medium text-gray-700">æœ€æ…¢é…é€Ÿ (min/km): <span id="val-21k-pace-slow" class="font-mono text-blue-600">6.5</span></label>
                                <input type="range" id="21k-pace-slow" value="6.5" min="4" max="12" step="0.5" class="w-full h-2 bg-blue-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <label for="21k-participants" class="block text-sm font-medium text-gray-700">åƒèˆ‡äººæ•¸ (äºº):</label>
                            <input type="number" id="21k-participants" value="10000" min="100" max="50000" step="100" class="w-full p-2 border border-blue-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <label for="21k-avg-width" class="block text-sm font-medium text-gray-700">å¹³å‡è³½é“å¯¬åº¦ (å…¬å°º):</label>
                            <input type="number" id="21k-avg-width" value="10" min="3" max="20" step="1" class="w-full p-2 border border-blue-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700">äººæµæŒçºŒæ™‚é–“ (min): <span id="val-21k-flow" class="font-mono text-xl font-bold text-blue-600">--</span></span>
                        </div>
                    </div>
                </div>

                <!-- 10K çµ„ -->
                <div id="group-10k" class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="text-lg font-bold text-green-800 mb-2">10K çµ„</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="10k-file" class="block text-sm font-medium text-gray-700">GPX æª”æ¡ˆä¸Šå‚³ (.gpx)</label>
                            <input type="file" id="10k-file" accept=".gpx" class="w-full p-1 border border-green-200 rounded-lg text-sm font-mono" onchange="handleFileUpload(event, '10k')">
                            <p id="10k-dist-display" class="text-xs text-green-600 mt-1 font-semibold">ç¸½è·é›¢: -- km</p>
                        </div>
                        
                        <!-- å‡ºç™¼æ™‚é–“ HH:MM -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç™¼æ™‚é–“ (æ™‚:åˆ†)</label>
                            <div class="flex items-center space-x-2">
                                <div class="relative flex-1">
                                    <input type="number" id="10k-start-h" value="6" min="0" max="23" class="w-full p-2 text-center border border-green-200 rounded-lg font-mono focus:ring-2 focus:ring-green-500 outline-none" placeholder="æ™‚">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">æ™‚</span>
                                </div>
                                <span class="text-gray-400 font-bold">:</span>
                                <div class="relative flex-1">
                                    <input type="number" id="10k-start-m" value="15" min="0" max="59" class="w-full p-2 text-center border border-green-200 rounded-lg font-mono focus:ring-2 focus:ring-green-500 outline-none" placeholder="åˆ†">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">åˆ†</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="10k-pace-fast" class="block text-sm font-medium text-gray-700">æœ€å¿«é…é€Ÿ (min/km): <span id="val-10k-pace-fast" class="font-mono text-green-600">6.0</span></label>
                                <input type="range" id="10k-pace-fast" value="6.0" min="3" max="8" step="0.5" class="w-full h-2 bg-green-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="10k-pace-slow" class="block text-sm font-medium text-gray-700">æœ€æ…¢é…é€Ÿ (min/km): <span id="val-10k-pace-slow" class="font-mono text-green-600">8.0</span></label>
                                <input type="range" id="10k-pace-slow" value="8.0" min="4" max="12" step="0.5" class="w-full h-2 bg-green-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <label for="10k-participants" class="block text-sm font-medium text-gray-700">åƒèˆ‡äººæ•¸ (äºº):</label>
                            <input type="number" id="10k-participants" value="5000" min="100" max="50000" step="100" class="w-full p-2 border border-green-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <label for="10k-avg-width" class="block text-sm font-medium text-gray-700">å¹³å‡è³½é“å¯¬åº¦ (å…¬å°º):</label>
                            <input type="number" id="10k-avg-width" value="8" min="3" max="20" step="1" class="w-full p-2 border border-green-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700">äººæµæŒçºŒæ™‚é–“ (min): <span id="val-10k-flow" class="font-mono text-xl font-bold text-green-600">--</span></span>
                        </div>
                    </div>
                </div>
                
                <!-- 5K è¿·ä½ é¦¬çµ„ -->
                <div id="group-5k" class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-500">
                    <h3 class="text-lg font-bold text-orange-800 mb-2">è¿·ä½ é¦¬çµ„ (5K)</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="5k-file" class="block text-sm font-medium text-gray-700">GPX æª”æ¡ˆä¸Šå‚³ (.gpx)</label>
                            <input type="file" id="5k-file" accept=".gpx" class="w-full p-1 border border-orange-200 rounded-lg text-sm font-mono" onchange="handleFileUpload(event, '5k')">
                            <p id="5k-dist-display" class="text-xs text-orange-600 mt-1 font-semibold">ç¸½è·é›¢: -- km</p>
                        </div>
                        
                        <!-- å‡ºç™¼æ™‚é–“ HH:MM -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç™¼æ™‚é–“ (æ™‚:åˆ†)</label>
                            <div class="flex items-center space-x-2">
                                <div class="relative flex-1">
                                    <input type="number" id="5k-start-h" value="6" min="0" max="23" class="w-full p-2 text-center border border-orange-200 rounded-lg font-mono focus:ring-2 focus:ring-orange-500 outline-none" placeholder="æ™‚">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">æ™‚</span>
                                </div>
                                <span class="text-gray-400 font-bold">:</span>
                                <div class="relative flex-1">
                                    <input type="number" id="5k-start-m" value="30" min="0" max="59" class="w-full p-2 text-center border border-orange-200 rounded-lg font-mono focus:ring-2 focus:ring-orange-500 outline-none" placeholder="åˆ†">
                                    <span class="absolute right-2 top-2 text-gray-400 text-xs">åˆ†</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="5k-pace-fast" class="block text-sm font-medium text-gray-700">æœ€å¿«é…é€Ÿ (min/km): <span id="val-5k-pace-fast" class="font-mono text-orange-600">7.5</span></label>
                                <input type="range" id="5k-pace-fast" value="7.5" min="3" max="8" step="0.5" class="w-full h-2 bg-orange-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="5k-pace-slow" class="block text-sm font-medium text-gray-700">æœ€æ…¢é…é€Ÿ (min/km): <span id="val-5k-pace-slow" class="font-mono text-orange-600">10.0</span></label>
                                <input type="range" id="5k-pace-slow" value="10.0" min="4" max="12" step="0.5" class="w-full h-2 bg-orange-100 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div>
                            <label for="5k-participants" class="block text-sm font-medium text-gray-700">åƒèˆ‡äººæ•¸ (äºº):</label>
                            <input type="number" id="5k-participants" value="3000" min="100" max="50000" step="100" class="w-full p-2 border border-orange-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <label for="5k-avg-width" class="block text-sm font-medium text-gray-700">å¹³å‡è³½é“å¯¬åº¦ (å…¬å°º):</label>
                            <input type="number" id="5k-avg-width" value="6" min="3" max="20" step="1" class="w-full p-2 border border-orange-200 rounded-lg text-sm font-mono">
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-gray-700">äººæµæŒçºŒæ™‚é–“ (min): <span id="val-5k-flow" class="font-mono text-xl font-bold text-orange-600">--</span></span>
                        </div>
                    </div>
                </div>

                <!-- è³½é“ç“¶é ¸è¨­å®š (å¤šé»è¼¸å…¥) -->
                <div class="p-4 rounded-lg border border-red-300">
                    <h3 class="text-lg font-bold text-red-800 mb-2">è³½é“ç“¶é ¸é» (è¼”åŠ©ç·š)</h3>
                    <div>
                        <label for="bottleneck-dists" class="block text-sm font-medium text-gray-700 mb-1">è¼¸å…¥ç“¶é ¸é»è·é›¢ (km, é€—è™Ÿåˆ†éš”):</label>
                        <input type="text" id="bottleneck-dists" value="5, 10, 15.5" class="w-full p-2 border border-red-200 rounded-lg text-sm font-mono" placeholder="ä¾‹å¦‚: 5, 10, 15.5">
                    </div>
                </div>
                
                <button id="analyze-button" onclick="analyzeAndDraw()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    é»æ“Šé–‹å§‹åˆ†æ
                </button>
            </div>
        </div>

        <!-- å³å´ï¼šåœ°åœ–èˆ‡åœ–è¡¨é¡¯ç¤ºå€ -->
        <div class="lg:w-2/3 flex flex-col">
            <!-- åœ°åœ–å€åŸŸ -->
            <div id="map" class="shadow-lg"></div>

            <!-- æ™‚ç©ºåœ–å€åŸŸ -->
            <div id="chart-container" class="rounded-xl shadow-lg mt-4 relative">
                <canvas id="flowChart" width="800" height="500" class="w-full"></canvas>
            </div>
            
            <!-- è¡çªçµæœå€ -->
            <div class="mt-4 p-4 bg-yellow-100 text-yellow-800 rounded-lg shadow">
                <h3 class="font-semibold mb-2">ğŸš¨ è¡çªåˆ†æå»ºè­°:</h3>
                <div id="conflict-message" class="text-sm">
                    è«‹å…ˆä¸Šå‚³ GPX æª”æ¡ˆä¸¦é»æ“Šã€Œé–‹å§‹åˆ†æã€æŒ‰éˆ•ã€‚
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- å…¨å±€è®Šæ•¸èˆ‡å¸¸é‡ ---
        
        // æ ¸å¿ƒçµ„åˆ¥é…ç½®
        const GROUPS = [
            { id: '21k', name: 'åŠé¦¬çµ„ (21K)', color: '#3b82f6' },
            { id: '10k', name: '10K çµ„', color: '#10b981' },
            { id: '5k', name: 'è¿·ä½ é¦¬çµ„ (5K)', color: '#f97316' },
        ];
        
        // ç‹€æ…‹ï¼šå„²å­˜è§£æå¾Œçš„ GPX æ•¸æ“š
        const gpxDataMap = {}; // { id: { distance: float, coords: [[lat, lon], ...], layer: LeafletLayer } }
        let MAX_CHART_DIST = 21.1; // åœ–è¡¨ X è»¸æœ€å¤§è·é›¢ (åˆå§‹åŒ–ç‚ºåŠé¦¬è·é›¢)

        // åœ–è¡¨å¸¸é‡
        const PADDING_LEFT = 70; // å¢åŠ å·¦å´ç©ºé–“ä»¥é¡¯ç¤ºæ™‚é–“
        const PADDING_BOTTOM = 30;
        const PADDING_TOP = 20;
        const PADDING_RIGHT = 10;
        const R_THROUGHPUT = 100; // ç¶“é©—å€¼: æ¯åˆ†é˜æ¯å…¬å°ºå¯¬åº¦å¯é€šéäººæ•¸ (Participants/min/meter)

        let map; // Leaflet åœ°åœ–å¯¦ä¾‹
        let WIDTH, HEIGHT, X_SCALE, Y_SCALE;
        let MIN_TIME_MINUTES = 0; // åœ–è¡¨ Y è»¸èµ·å§‹æ™‚é–“ (åˆ†é˜)
        let MAX_TIME_MINUTES = 0; // åœ–è¡¨ Y è»¸çµæŸæ™‚é–“ (åˆ†é˜)
        
        const canvas = document.getElementById('flowChart');
        const ctx = canvas.getContext('2d');

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ ---

        // æ ¼å¼åŒ–åˆ†é˜æ•¸ç‚º HH:MM
        function formatTime(totalMinutes) {
            let h = Math.floor(totalMinutes / 60);
            let m = Math.floor(totalMinutes % 60);
            // è™•ç†è·¨æ—¥æƒ…æ³ (å¤§æ–¼24å°æ™‚)
            if (h >= 24) h = h % 24;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        /**
         * ç°¡æ˜“ Haversine è·é›¢è¨ˆç®— (è¿”å›å…¬é‡Œ)
         */
        function calculateDistance(coords) {
            if (coords.length < 2) return 0;
            let totalDist = 0;
            for (let i = 1; i < coords.length; i++) {
                const [lat1, lon1] = coords[i - 1];
                const [lat2, lon2] = coords[i];
                
                const dLat = (lat2 - lat1) * 111.0; 
                const dLon = (lon2 - lon1) * Math.cos(lat1 * (Math.PI / 180)) * 111.0; 
                
                totalDist += Math.sqrt(dLat * dLat + dLon * dLon);
            }
            return totalDist;
        }

        /**
         * ä½¿ç”¨ DOMParser è§£æ GPX æª”æ¡ˆå…§å®¹
         */
        function parseGPX(gpxText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(gpxText, "text/xml");
            
            const errorNode = xmlDoc.querySelector('parsererror');
            if (errorNode) {
                throw new Error("GPX æª”æ¡ˆè§£æéŒ¯èª¤ï¼šè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
            }
            
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            const coords = [];
            
            for (let i = 0; i < trkpts.length; i++) {
                const lat = parseFloat(trkpts[i].getAttribute("lat"));
                const lon = parseFloat(trkpts[i].getAttribute("lon"));
                if (!isNaN(lat) && !isNaN(lon)) {
                    coords.push([lat, lon]);
                }
            }
            
            if (coords.length === 0) {
                 throw new Error("GPX æª”æ¡ˆä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„è·¯å¾‘é» (<trkpt>)ã€‚");
            }
            
            const distance = calculateDistance(coords);
            return { coords, distance };
        }

        // --- åœ°åœ–è™•ç†é‚è¼¯ ---

        function initMap() {
            if (map) map.remove(); 
            map = L.map('map').setView([25.03, 121.56], 13); 
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function drawPath(groupId) {
            const data = gpxDataMap[groupId];
            if (!data) return;

            if (data.layer) {
                map.removeLayer(data.layer);
            }
            
            const groupConfig = GROUPS.find(g => g.id === groupId);
            
            const polyline = L.polyline(data.coords, {
                color: groupConfig.color,
                weight: 5,
                opacity: 0.8,
            }).addTo(map);

            data.layer = polyline; 
            map.fitBounds(polyline.getBounds());
        }

        async function handleFileUpload(event, groupId) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const result = parseGPX(text);
                        
                        gpxDataMap[groupId] = {
                            coords: result.coords,
                            distance: result.distance,
                            layer: null
                        };

                        const distDisplay = document.getElementById(`${groupId}-dist-display`);
                        if (distDisplay) {
                            distDisplay.textContent = `è§£æè·é›¢: ${result.distance.toFixed(2)} km`;
                        }

                        drawPath(groupId);

                    } catch (err) {
                        alert(`è§£æå¤±æ•—: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            } catch (err) {
                console.error(err);
                alert("æª”æ¡ˆè®€å–éŒ¯èª¤");
            }
        }

        // --- åˆ†æèˆ‡ç¹ªåœ–é‚è¼¯ ---

        function getParams() {
            const params = {
                bottleneckDists: [],
                groups: {}
            };
            
            GROUPS.forEach(group => {
                const participants = parseFloat(document.getElementById(`${group.id}-participants`).value) || 0;
                const avgWidth = parseFloat(document.getElementById(`${group.id}-avg-width`).value) || 1;
                const paceFast = parseFloat(document.getElementById(`${group.id}-pace-fast`).value);
                const paceSlow = parseFloat(document.getElementById(`${group.id}-pace-slow`).value);
                
                // è®€å–æ–°çš„å‡ºç™¼æ™‚é–“è¼¸å…¥ (æ™‚:åˆ†)
                const startH = parseInt(document.getElementById(`${group.id}-start-h`).value) || 0;
                const startM = parseInt(document.getElementById(`${group.id}-start-m`).value) || 0;
                // å°‡æ™‚é–“è½‰æ›ç‚ºã€Œç•¶å¤©ç¸½åˆ†é˜æ•¸ã€ (ä¾‹å¦‚ 06:30 => 390 åˆ†é˜)
                const startTotalMinutes = startH * 60 + startM;

                let flowTime = 0;
                if (avgWidth > 0) {
                    flowTime = participants / (avgWidth * R_THROUGHPUT);
                }
                const flow = Math.max(flowTime, 0.1); 

                let distance = 0;
                if (gpxDataMap[group.id] && gpxDataMap[group.id].distance) {
                    distance = gpxDataMap[group.id].distance;
                } else {
                    distance = group.id === '21k' ? 21.1 : (group.id === '10k' ? 10 : 5);
                }

                params.groups[group.id] = {
                    start: startTotalMinutes, // ä½¿ç”¨ç¸½åˆ†é˜æ•¸
                    paceFast: paceFast,
                    paceSlow: paceSlow,
                    flow: flow,
                    distance: distance,
                    color: group.color,
                    name: group.name
                };
            });
            
            const bottleneckInput = document.getElementById('bottleneck-dists').value;
            params.bottleneckDists = bottleneckInput.split(',')
                .map(s => parseFloat(s.trim()))
                .filter(n => !isNaN(n) && n > 0);

            return params;
        }

        function updateValueDisplay() {
            GROUPS.forEach(group => {
                // ä¸å†éœ€è¦æ›´æ–°æ»‘æ¡¿çš„æ–‡å­—ï¼Œä½†ä»éœ€æ›´æ–°äººæµæ™‚é–“
                document.getElementById(`val-${group.id}-pace-fast`).textContent = document.getElementById(`${group.id}-pace-fast`).value;
                document.getElementById(`val-${group.id}-pace-slow`).textContent = document.getElementById(`${group.id}-pace-slow`).value;
                
                const participants = parseFloat(document.getElementById(`${group.id}-participants`).value) || 0;
                const avgWidth = parseFloat(document.getElementById(`${group.id}-avg-width`).value) || 1;
                let flowTime = participants / (avgWidth * R_THROUGHPUT);
                document.getElementById(`val-${group.id}-flow`).textContent = `${flowTime.toFixed(1)} min`;
            });
        }

        function analyzeAndDraw() {
            WIDTH = canvas.width;
            HEIGHT = canvas.height;
            const params = getParams();

            // 1. è¨ˆç®—æ‰€æœ‰æ•¸æ“šçš„é‚Šç•Œ
            let maxDist = 0;
            let minTime = Infinity;
            let maxTime = 0;

            Object.values(params.groups).forEach(g => {
                if (g.distance > maxDist) maxDist = g.distance;
                
                // é–‹å§‹æ™‚é–“
                if (g.start < minTime) minTime = g.start;
                
                // çµæŸæ™‚é–“ (é–‹å§‹ + æµé‡ + è·é›¢*æ…¢é€Ÿ)
                const endTime = g.start + g.flow + (g.distance * g.paceSlow);
                if (endTime > maxTime) maxTime = endTime;
            });

            // è¨­å®šåœ–è¡¨é‚Šç•Œ
            MAX_CHART_DIST = Math.max(maxDist, 5);
            // æ™‚é–“è»¸è¨­å®šï¼šèµ·é»ç‚ºæœ€æ—©å‡ºç™¼æ™‚é–“æ¸›ä¸€é»ç·©è¡ï¼Œçµ‚é»ç‚ºæœ€æ™šçµæŸæ™‚é–“åŠ ç·©è¡
            // ç‚ºäº†æ•´é»é¡¯ç¤ºç¾è§€ï¼Œæˆ‘å€‘å°‡ minTime å‘ä¸‹å–æ•´åˆ°æœ€è¿‘çš„30åˆ†é˜
            MIN_TIME_MINUTES = Math.floor(minTime / 30) * 30;
            MAX_TIME_MINUTES = Math.ceil(maxTime / 30) * 30;
            
            // ç¢ºä¿æœ‰è¶³å¤ çš„å€é–“
            if (MAX_TIME_MINUTES - MIN_TIME_MINUTES < 60) {
                MAX_TIME_MINUTES = MIN_TIME_MINUTES + 60;
            }

            const timeRange = MAX_TIME_MINUTES - MIN_TIME_MINUTES;

            X_SCALE = (WIDTH - PADDING_LEFT - PADDING_RIGHT) / MAX_CHART_DIST;
            Y_SCALE = (HEIGHT - PADDING_TOP - PADDING_BOTTOM) / timeRange;

            // 2. ç¹ªåœ–
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            drawAxes(params.bottleneckDists);

            GROUPS.forEach(group => {
                drawTrapezoid(params.groups[group.id]);
            });

            checkConflicts(params);
        }

        // åæ¨™è½‰æ› (Yè»¸åè½‰ï¼šæ™‚é–“è¶Šæ™šåœ¨è¶Šä¸Šé¢ï¼Ÿé€šå¸¸æ™‚ç©ºåœ–æ™‚é–“Yè»¸æ˜¯å‘ä¸Šæˆ–å‘ä¸‹)
        // é€™è£¡æˆ‘å€‘æ¡ç”¨ï¼šYè»¸å‘ä¸Šè¡¨ç¤ºæ™‚é–“æµé€ (æˆ–è€…æ˜¯ç‰©ç†è·é›¢åœ–é€šå¸¸ Y è»¸æ˜¯æ™‚é–“)
        // ç‚ºäº†ç¬¦åˆç›´è¦º (é¡ä¼¼ç”˜ç‰¹åœ–æˆ–ç«è»Šæ™‚åˆ»è¡¨)ï¼Œé€šå¸¸ Y è»¸å‘ä¸‹è¡¨ç¤ºæ™‚é–“è®Šæ™šï¼ŒX è»¸æ˜¯è·é›¢
        // ä½†æ˜¯ä¹‹å‰çš„ä»£ç¢¼æ˜¯ Y è»¸å‘ä¸Šç‚º 0? 
        // ä¿®æ­£ï¼šä¸€èˆ¬æ™‚ç©ºåœ– (Time-Space Diagram) Yè»¸å‘ä¸Šè¡¨ç¤ºæ™‚é–“å¢åŠ ï¼Œæˆ– Yè»¸å‘ä¸‹ã€‚
        // åŸæœ¬ä»£ç¢¼ `toCanvasY(time) { return HEIGHT - PADDING_BOTTOM - time * Y_SCALE; }` 
        // é€™è¡¨ç¤º Canvas Y=Height (åº•éƒ¨) æ˜¯ time=0ã€‚é€™æ„å‘³è‘—æ™‚é–“æ˜¯å¾ä¸‹å¾€ä¸Šè·‘ã€‚
        // ä½†æˆ‘å€‘æ”¹ç”¨çµ•å°æ™‚é–“å¾Œï¼Œé€šå¸¸ç¿’æ…£ã€Œä¸Šåˆ°ä¸‹ã€æˆ–ã€Œä¸‹åˆ°ä¸Šã€ã€‚
        // ç‚ºäº†ä¿æŒä¸€è‡´æ€§ï¼Œæˆ‘å€‘ç¶­æŒï¼šYè»¸åº•éƒ¨æ˜¯è¼ƒæ—©çš„æ™‚é–“ (MIN_TIME)ï¼Œé ‚éƒ¨æ˜¯è¼ƒæ™šçš„æ™‚é–“ (MAX_TIME)ã€‚
        // é€™æ¨£åœ–è¡¨çœ‹èµ·ä¾†åƒæ˜¯å¾€ä¸Šçˆ¬å‡ã€‚
        function toCanvasX(dist) { 
            return PADDING_LEFT + dist * X_SCALE; 
        }
        function toCanvasY(timeMinutes) {
            // å°‡æ™‚é–“æ˜ å°„åˆ°ç•«å¸ƒé«˜åº¦ï¼š(time - MIN) * Scale
            // æ³¨æ„ï¼šCanvas (0,0) åœ¨å·¦ä¸Šè§’ã€‚
            // æˆ‘å€‘å¸Œæœ› MIN_TIME åœ¨åº•éƒ¨ (Yå¤§)ï¼ŒMAX_TIME åœ¨é ‚éƒ¨ (Yå°)
            return HEIGHT - PADDING_BOTTOM - (timeMinutes - MIN_TIME_MINUTES) * Y_SCALE;
        }

        function drawTrapezoid(data) {
            const { start, paceFast, paceSlow, flow, distance, color, name } = data;
            
            const p1 = { d: 0, t: start };
            const p2 = { d: distance, t: start + distance * paceFast };
            const p3 = { d: distance, t: start + flow + distance * paceSlow };
            const p4 = { d: 0, t: start + flow };

            const path = [
                { x: toCanvasX(p1.d), y: toCanvasY(p1.t) },
                { x: toCanvasX(p2.d), y: toCanvasY(p2.t) },
                { x: toCanvasX(p3.d), y: toCanvasY(p3.t) },
                { x: toCanvasX(p4.d), y: toCanvasY(p4.t) }
            ];

            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            ctx.lineTo(path[1].x, path[1].y);
            ctx.lineTo(path[2].x, path[2].y);
            ctx.lineTo(path[3].x, path[3].y);
            ctx.closePath();

            ctx.fillStyle = color + '80'; 
            ctx.fill();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 12px Inter';
            // æ¨™ç±¤ä½ç½®å¾®èª¿
            ctx.fillText(name, path[0].x + 5, path[0].y - 5);
        }

        function drawAxes(bottleneckDists) {
            const AXIS_COLOR = '#4b5563';
            const GRID_COLOR = '#e5e7eb';

            // X è»¸
            ctx.beginPath();
            ctx.moveTo(PADDING_LEFT, HEIGHT - PADDING_BOTTOM);
            ctx.lineTo(WIDTH - PADDING_RIGHT, HEIGHT - PADDING_BOTTOM);
            ctx.strokeStyle = AXIS_COLOR;
            ctx.lineWidth = 1;
            ctx.stroke();

            // Y è»¸
            ctx.beginPath();
            ctx.moveTo(PADDING_LEFT, HEIGHT - PADDING_BOTTOM);
            ctx.lineTo(PADDING_LEFT, PADDING_TOP);
            ctx.stroke();

            // X è»¸åˆ»åº¦
            for (let d = 0; d <= Math.ceil(MAX_CHART_DIST); d += 2.5) {
                const x = toCanvasX(d);
                if (x > WIDTH) break;
                
                ctx.beginPath();
                ctx.moveTo(x, HEIGHT - PADDING_BOTTOM);
                ctx.lineTo(x, PADDING_TOP);
                ctx.strokeStyle = GRID_COLOR;
                ctx.stroke();

                ctx.fillStyle = AXIS_COLOR;
                ctx.textAlign = 'center';
                ctx.fillText(d.toString(), x, HEIGHT - PADDING_BOTTOM + 15);
            }
            ctx.fillText("è·é›¢ (km)", WIDTH / 2, HEIGHT - 5);

            // Y è»¸åˆ»åº¦ (æ™‚é–“)
            // æ¯ 30 åˆ†é˜ä¸€å€‹åˆ»åº¦
            for (let t = MIN_TIME_MINUTES; t <= MAX_TIME_MINUTES; t += 30) {
                const y = toCanvasY(t);
                
                ctx.beginPath();
                ctx.moveTo(PADDING_LEFT, y);
                ctx.lineTo(WIDTH - PADDING_RIGHT, y);
                ctx.strokeStyle = GRID_COLOR;
                ctx.stroke();

                ctx.fillStyle = AXIS_COLOR;
                ctx.textAlign = 'right';
                // é¡¯ç¤º HH:MM
                ctx.fillText(formatTime(t), PADDING_LEFT - 5, y + 5);
            }
            
            ctx.save();
            ctx.translate(15, HEIGHT / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText("æ™‚é–“ (æ™‚åˆ»)", 0, 0);
            ctx.restore();

            // ç“¶é ¸ç·š
            bottleneckDists.forEach((d, idx) => {
                if (d > MAX_CHART_DIST) return;
                const x = toCanvasX(d);
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(x, HEIGHT - PADDING_BOTTOM);
                ctx.lineTo(x, PADDING_TOP);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = 'red';
                ctx.textAlign = 'center';
                ctx.fillText(`ç“¶é ¸ ${idx+1}`, x, PADDING_TOP + 10 + (idx%2)*12);
            });
        }

        function checkConflicts(params) {
            let conflictMsg = "";
            let hasConflict = false;
            const groupIds = Object.keys(params.groups);

            params.bottleneckDists.forEach(dist => {
                const passingGroups = [];
                
                groupIds.forEach(gid => {
                    const g = params.groups[gid];
                    if (g.distance >= dist) {
                        const tStart = g.start + dist * g.paceFast;
                        const tEnd = g.start + g.flow + dist * g.paceSlow;
                        passingGroups.push({ id: gid, name: g.name, tStart, tEnd });
                    }
                });

                for (let i = 0; i < passingGroups.length; i++) {
                    for (let j = i + 1; j < passingGroups.length; j++) {
                        const g1 = passingGroups[i];
                        const g2 = passingGroups[j];
                        
                        const overlapStart = Math.max(g1.tStart, g2.tStart);
                        const overlapEnd = Math.min(g1.tEnd, g2.tEnd);
                        
                        if (overlapStart < overlapEnd) {
                            hasConflict = true;
                            // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
                            const tStrStart = formatTime(overlapStart);
                            const tStrEnd = formatTime(overlapEnd);
                            
                            conflictMsg += `<div class="mb-2 p-2 bg-red-50 border-l-4 border-red-500 text-red-700">
                                <strong>${dist} km è™•è¡çªï¼š</strong> ${g1.name} èˆ‡ ${g2.name} é‡ç–Šã€‚<br>
                                é‡ç–Šæ™‚æ®µ: ${tStrStart} ~ ${tStrEnd}
                            </div>`;

                            const x = toCanvasX(dist);
                            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                            ctx.fillRect(x - 5, toCanvasY(overlapEnd), 10, toCanvasY(overlapStart) - toCanvasY(overlapEnd));
                        }
                    }
                }
            });

            const msgDiv = document.getElementById('conflict-message');
            if (hasConflict) {
                msgDiv.innerHTML = conflictMsg;
            } else {
                msgDiv.innerHTML = '<p class="text-green-600 font-bold">âœ… ç›®å‰åœ¨æŒ‡å®šç“¶é ¸é»æœªç™¼ç¾æ˜é¡¯çš„æ™‚é–“é‡ç–Šè¡çªã€‚</p>';
            }
        }

        window.addEventListener('load', () => {
            initMap();
            const controls = document.getElementById('controls');
            controls.addEventListener('input', updateValueDisplay);
            updateValueDisplay();
            const container = document.getElementById('chart-container');
            canvas.width = container.clientWidth;
        });

        window.addEventListener('resize', () => {
             const container = document.getElementById('chart-container');
             canvas.width = container.clientWidth;
             // å¦‚æœ X_SCALE å­˜åœ¨ï¼ˆè¡¨ç¤ºå·²ç¶“åˆ†æéï¼‰ï¼Œå‰‡é‡ç¹ª
             if (X_SCALE) analyzeAndDraw();
        });

    </script>
</body>
</html>